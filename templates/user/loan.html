<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è¨­å‚™å€Ÿç”¨</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
</head>
<body>

<div class="wrapper">
  <!-- å´é‚Šæ¬„ -->
  <aside class="sidebar">
    <div class="logo">XXXç¤¾å“¡</div>
    <nav class="menu">
      <a href="/loan" class="active">è¨­å‚™å€Ÿç”¨</a>
      <a href="/userRecord">å€Ÿç”¨ç´€éŒ„</a>
    </nav>
  </aside>

  <main class="main">
    <div class="top-bar"></div>
    <a href="/login" class="home-button">
    </a>
    <div class="content content-equipment">
      <!-- âœ… é¡¯ç¤ºä¿¡ç”¨åˆ†æ•¸ -->
      <div class="credit-box">
          My CREDIT <span id="creditValue" class="credit-score">--</span>
      </div>
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="æœå°‹å™¨æ" oninput="filterTable()" />
      </div>

      <table>
        <thead>
        <tr>
            <th>NO.</th>
            <th>Name</th>
            <th>Description</th>
            <th>Status</th>
            <th>Loan</th>
        </tr>
        </thead>
        <tbody id="equipment-table-body">
        </tbody>
      </table>
    </div>
  </main>
</div>

<!-- ğŸ“… æ—¥æ›† Modal -->
<div id="calendarModal" class="calendar-modal">
  <button class="modal-close" onclick="closeCalendar()">âœ–</button>
  <h2>å€Ÿç”¨æ™‚æ®µ</h2>
  <div id="calendar"></div>
  <p class="tag" style="background-color: #777;">æ·±ç°ï¼šå€Ÿå‡º/ç¶­ä¿®ä¸­</p>
  <br />
  <button class="brown-btn" onclick="confirmBooking()">é ç´„</button>
</div>

<!-- âœ… æˆåŠŸæç¤º -->
<div id="successPopup" class="toast-message">æ­å–œä½ ï¼é ç´„æˆåŠŸï¼</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
  let calendar;
  let selectedRange = null;
  let currentBookingEvent = null;
  let currentEquipmentId = null;

  function getEquipment() {
    fetch('/equipment')
      .then(response => {
        // æª¢æŸ¥éŸ¿æ‡‰ç‹€æ…‹
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        // æª¢æŸ¥éŸ¿æ‡‰é¡å‹
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new TypeError("è¿”å›çš„æ•¸æ“šä¸æ˜¯ JSON æ ¼å¼!");
        }
        return response.json();
      })
      .then(data => {
        console.log('ç²å–åˆ°çš„å™¨ææ•¸æ“š:', data);
        const tbody = document.getElementById('equipment-table-body');
        tbody.innerHTML = '';
        
        if (!data || data.length === 0) {
          console.log('æ²’æœ‰å™¨ææ•¸æ“š');
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">æš«ç„¡å™¨ææ•¸æ“š</td></tr>';
          return;
        }
        
        data.forEach((equipment, index) => {
          console.log('è™•ç†å™¨æ:', equipment);
          const row = document.createElement('tr');
          
          // è¨­ç½®ç‹€æ…‹æ¨£å¼
          let statusClass = '';
          let statusText = '';
          
          switch(equipment.equipment_status) {
            case 'available':
              statusClass = 'success';
              statusText = 'å¯å€Ÿç”¨';
              break;
            case 'borrowed':
              statusClass = 'danger';
              statusText = 'å·²å€Ÿå‡º';
              break;
            case 'repairing':
              statusClass = 'warning';
              statusText = 'ç¶­ä¿®ä¸­';
              break;
            case 'pending_inspection':
              statusClass = 'warning';
              statusText = 'æª¢æŸ¥ä¸­';
              break;
            default:
              statusClass = 'danger';
              statusText = 'ç„¡æ³•ä½¿ç”¨';
          }

          row.innerHTML = `
            <td>${equipment.equipment_id}</td>
            <td>${equipment.equipment_name}</td>
            <td>${equipment.equipment_description || '--- æè¿° ---'}</td>
            <td><span class="tag ${statusClass}">${statusText}</span></td>
            <td>
              <button class="gray-btn" 
                onclick="openCalendar('${equipment.equipment_id}')"
                ${equipment.equipment_status !== 'available' ? 'disabled' : ''}>
                æŸ¥çœ‹
              </button>
            </td>
          `;
          
          tbody.appendChild(row);
        });
      })
      .catch(error => {
        console.error('ç²å–å™¨æåˆ—è¡¨å¤±æ•—:', error);
        const tbody = document.getElementById('equipment-table-body');
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: red;">
              ç²å–å™¨æåˆ—è¡¨å¤±æ•—: ${error.message}
            </td>
          </tr>
        `;
      });
  }

  function filterTable() {
    const input = document.getElementById("searchInput").value.toUpperCase();
    const rows = document.querySelectorAll("#equipment-table-body tr");
    rows.forEach(row => {
      const cell = row.querySelector("td:nth-child(2)");
      const match = cell.textContent.toUpperCase().includes(input);
      row.style.display = match ? "" : "none";
    });
  }

  function openCalendar(equipmentId) {
    currentEquipmentId = equipmentId;

    // æ¨¡æ“¬ä¸å¯å€Ÿç”¨çš„æ™‚æ®µï¼ˆborrowed, repairï¼‰
    const unavailable = [
      { title: 'ä¸å¯é¸', start: '2025-06-05', end: '2025-06-08', color: '#777' },
      { title: 'ä¸å¯é¸', start: '2025-06-09', end: '2025-06-15', color: '#777' }
    ];

    // æ¨¡æ“¬ä½¿ç”¨è€…è‡ªå·±å·²é ç´„çš„æ™‚æ®µ
    // TODO: å¾Œç«¯æ‡‰å›å‚³ is_owner å±¬æ€§
    const ownBooking = currentBookingEvent
      ? [currentBookingEvent]
      : [];

    document.getElementById("calendarModal").classList.add("active");

    setTimeout(() => {
      const calendarEl = document.getElementById("calendar");
      calendarEl.innerHTML = "";

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 400,
        selectable: true,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth'
        },
        titleFormat: { year: 'numeric', month: 'long' },
        buttonText: {
          today: 'ä»Šå¤©'
        },

        // âœ… å¯é¸æ“‡å€æ®µ
        select(info) {
          const conflict = calendar.getEvents().some(ev => {
            return ev.title === 'ä¸å¯é¸' && info.start < ev.end && info.end > ev.start;
          });
          if (conflict) {
            alert("é¸å–å€æ®µåŒ…å«ä¸å¯å€Ÿç”¨æ—¥æœŸï¼Œè«‹é‡æ–°é¸æ“‡ï¼");
            return;
          }

          selectedRange = info;

          // æ¸…é™¤åŸæœ‰é¸æ“‡æç¤º
          calendar.getEvents().forEach(ev => {
            if (ev.title === 'é¸æ“‡ä¸­') ev.remove();
          });

          // é¡¯ç¤ºæ–°é¸æ“‡
          calendar.addEvent({
            title: 'é¸æ“‡ä¸­',
            start: info.startStr,
            end: info.endStr,
            color: '#6bb46a'
          });
        },

        // âœ… é»æ“Šè‡ªå·±çš„é ç´„ â†’ å¯å–æ¶ˆ
        eventClick(info) {
          if (info.event.id === 'booking') {
            info.event.remove();
            currentBookingEvent = null;
            selectedRange = null;
          }
        },

        events: unavailable.concat(ownBooking)
      });

      calendar.render();
    }, 100);
  }

  function closeCalendar() {
    document.getElementById("calendarModal").classList.remove("active");
  }

  function confirmBooking() {
    if (!selectedRange) {
      alert('è«‹é¸æ“‡å€Ÿç”¨æ™‚æ®µ');
      return;
    }

    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      alert('è«‹å…ˆç™»å…¥ï¼');
      window.location.href = '/userLogin';
      return;
    }

    // æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
    const startDate = selectedRange.start.toISOString().split('T')[0];
    // å°‡çµæŸæ—¥æœŸæ¸›å»ä¸€å¤©ï¼Œå› ç‚º FullCalendar çš„ end æ˜¯æ’ä»–æ€§çš„
    const endDate = new Date(selectedRange.end);
    endDate.setDate(endDate.getDate() - 1);
    const formattedEndDate = endDate.toISOString().split('T')[0];

    console.log('ç™¼é€é ç´„è«‹æ±‚:', {
      user_id: user.user_id,
      equipment_id: currentEquipmentId,
      start_date: startDate,
      end_date: formattedEndDate
    });

    // ç™¼é€å€Ÿç”¨è¨˜éŒ„åˆ°å¾Œç«¯
    fetch('/record', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        user_id: user.user_id,
        equipment_id: currentEquipmentId,
        start_date: startDate,
        end_date: formattedEndDate
      })
    })
    .then(async response => {
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error?.message || 'é ç´„å¤±æ•—');
      }
      return data;
    })
    .then(data => {
      // æ¸…é™¤ç‹€æ…‹
      selectedRange = null;
      
      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      const popup = document.getElementById("successPopup");
      popup.textContent = data.is_immediate ? 'å€Ÿç”¨æˆåŠŸï¼' : 'é ç´„æˆåŠŸï¼';
      popup.classList.add("active");
      
      setTimeout(() => {
        popup.classList.remove("active");
        // é—œé–‰æ—¥æ›†è¦–çª—
        closeCalendar();
        // é‡æ–°è¼‰å…¥å™¨æåˆ—è¡¨
        getEquipment();
      }, 1000);
    })
    .catch(error => {
      console.error('é ç´„éŒ¯èª¤:', error);
      alert(error.message || 'é ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      // ç§»é™¤é ç´„äº‹ä»¶
      calendar.getEvents().forEach(ev => {
        if (ev.id === 'booking') ev.remove();
      });
      currentBookingEvent = null;
    });
  }
  // âœ… åˆå§‹åŒ–æ™‚æ’ˆå– CREDIT åˆ†æ•¸
  window.onload = async function () {
    try {
      // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²ç™»å…¥
      const user = JSON.parse(localStorage.getItem('user'));
      if (!user) {
        alert('è«‹å…ˆç™»å…¥ï¼');
        window.location.href = '/userLogin';
        return;
      }

      // ç²å–ä½¿ç”¨è€…ä¿¡ç”¨åˆ†æ•¸
      const response = await fetch(`/user/${user.user_id}/score`);
      if (!response.ok) {
        throw new Error('ç²å–ä¿¡ç”¨åˆ†æ•¸å¤±æ•—');
      }
      const data = await response.json();
      document.getElementById('creditValue').textContent = data.credit_score || '--';

      // ç²å–å™¨æåˆ—è¡¨
      getEquipment();
    } catch (err) {
      console.error("åˆå§‹åŒ–å¤±æ•—:", err);
      document.getElementById('creditValue').textContent = '--';
      alert('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
    }
  };
</script>
</body>
</html>

